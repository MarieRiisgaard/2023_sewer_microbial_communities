---
title: "Rodrigos_article"
author: "Marie"
date: "2024-06-16"
output:
  html_document:
    toc: true
    toc_float: true
---


```{r markdown setup, include=FALSE}
knitr::opts_chunk$set(
  fig.retina=3,
  out.height = "90%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  error = FALSE
  )

```

```{r load packages, include=FALSE}
# Path and packages
pacman::p_load(ampvis2, 
               tidyverse, 
               ggplot2, 
               #patchwork,
               ggtext, tidyr, 
               ggrepel, 
               vegan,
               ggh4x, 
               stats, rstatix, ggpubr,
               #chron, 
               knitr
               )

setwd("C:/Users/HD95LP/OneDrive - Aalborg Universitet/visual_studio_code/2023_sewer_microbial_communities")

WD = "C:/Users/HD95LP/OneDrive - Aalborg Universitet/visual_studio_code/2023_sewer_microbial_communities/"
DataPath = paste0("C:/Users/HD95LP/OneDrive - Aalborg Universitet/visual_studio_code/2023_sewer_microbial_communities/", "data/")
OutputPath = paste0("C:/Users/HD95LP/OneDrive - Aalborg Universitet/visual_studio_code/2023_sewer_microbial_communities/", "output/")

source(paste0(WD, "scripts/load_sewer_data_function_Rodrigo.R"))

```

# Load data 

Load data: sintax = 0.6

```{r, load data sintax 0.6, include=FALSE}
sewer_data_list_0.6 <- 
  make_sewer_data(
    save_unclassified = F,
    new_long_df = T,
    new_core_groups = T,
    new_control_df = T, 
    make_usearch_plot = F, 
    sintax_file = "ASVs_0.6_cut_off_MIDAS_5.2.R1.sintax"
)

# Long data 
data_long_0.6 <- sewer_data_list_0.6[[3]] %>% 
  mutate(SampleContent2 = 
           factor(SampleContent2, 
           levels = c("biofilm", "sediment", "biofilm_end_pressure", "biofilm_RG","sewage", "IWW","AS"), 
            labels = c("Biofilm (g.)", "Sediment",  "Biofilm (e.p.)","Biofilm (p.)","SWW", "IWW", "AS")),
         Configuration = factor(Configuration, 
                                levels = c("gravity_pipes", "end_of_pressure",
                                           "wide_pressure_pipes","small_pressure_pipes", "WWTP"),
                                labels = c("Gravity sewers", "Pressure sewers",
                                           "Pressure sewers", "Pressure sewers", "WWTP"))
         ) %>% 
  filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>%
  filter(SampleContent2 != "Sediment")
  
# ampvis data 
data_0.6 <- sewer_data_list_0.6[[2]] 
data_0.6$metadata$SampleContent2 <- 
  factor(data_0.6$metadata$SampleContent2, 
      levels = c("biofilm", "sediment", "biofilm_end_pressure", "biofilm_RG","sewage", "IWW","AS"), 
            labels = c("Biofilm (g.)", "Sediment",  "Biofilm (e.p.)","Biofilm (p.)","SWW", "IWW", "AS")) 
data_0.6 <- data_0.6 %>% 
  amp_subset_samples(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>%
  amp_subset_samples(SampleContent2 != "Sediment")
#data_0.6$tax <- data_0.6$tax %>% change_tax_names()
metadata <- data_0.6$metadata


```


Load data: sintax = 0.8

```{r, load data sintax 0.8, include=FALSE}
sewer_data_list_0.8 <- 
  make_sewer_data(
    save_unclassified = F,
    new_long_df = T,
    new_core_groups = T,
    new_control_df = T, 
    make_usearch_plot = F, 
    sintax_file = "ASVs.R1.sintax"
)

# Long data 
data_long_0.8 <- sewer_data_list_0.8[[3]] %>% 
  mutate(SampleContent2 = 
           factor(SampleContent2, 
            levels = c("biofilm", "sediment", "biofilm_end_pressure", "biofilm_RG","sewage", "IWW","AS"), 
            labels = c("Biofilm (g.)", "Sediment",  "Biofilm (e.p.)","Biofilm (p.)","SWW", "IWW", "AS")),
         Configuration = factor(Configuration, 
                                levels = c("gravity_pipes", "end_of_pressure", "wide_pressure_pipes","small_pressure_pipes", "WWTP"),
                                labels = c("Gravity sewers", "Pressure sewers","Pressure sewers", "Pressure sewers", "WWTP"))
         ) %>% 
  filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>%
  filter(SampleContent2 != "Sediment")

data_0.8 <- sewer_data_list_0.8[[2]]
data_0.8$metadata$SampleContent2 <- 
  factor(data_0.8$metadata$SampleContent2, 
      levels = c("biofilm", "sediment", "biofilm_end_pressure", "biofilm_RG","sewage", "IWW","AS"), 
            labels = c("Biofilm (g.)", "Sediment",  "Biofilm (e.p.)","Biofilm (p.)","SWW", "IWW", "AS"))

#data_0.8$tax <- data_0.8$tax %>% change_tax_names()
metadata <- data_0.8$metadata
data_0.8 <- data_0.8 %>% 
  amp_subset_samples(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>%
  amp_subset_samples(SampleContent2 != "Sediment")

rm(including_unclassified_ASV_in_growth, new_temp_by_date, usearch_effect_plot,
   make_sewer_data, species_level_classification_gut_microbes, including_unclassified_ASV_in_gut)

```



# Load functions and groups 

```{r, include=T, echo=TRUE}
# Functions: 
source(paste0(WD, "scripts/finding_the_core.R"))
source(paste0(WD, "../2023_RETHINK_sample_collection/scripts/functions/PCOA_from_long_data.R"))
source(paste0(WD, "../2023_MiDAS_OK_testing/script/ADONIS_from_long_data.R"))
# Make PCoA on the differnet taxonomic levels 
source(paste0(WD, "../2023_RETHINK_sample_collection/scripts/functions/PCOA_from_long_data.R"))
source(paste0(WD, "scripts/functions/growing_dying_bar_plot.R"))


SampleContent2_colors <- c("#1e8449","#21618C","#b03a2e", "#ffb74d", "#e65100", "#795548")


# Functional groups
Nitrifiers = c("g__Nitrosomonas","g__Nitrosospira","g__Nitrospira","g__Nitrotoga")
Denitrifiers = c("g__Zoogloea", "g__Rhodoferax", "g__Thauera", "g__Rhodobacter", 
                 "g__Sulfuritalea", "g__Paracoccus", "g__Azoarcus")
PAOs <- c(
 "g__Ca_Phosphoribacter",
 "g__Azonexus",
 "g__Ca_Accumulibacter",
 "g__Ca_Lutibacillus",
 "g__Tetrasphaera",
 "g__Microlunatus" )
GAOs <- c("g__Ca_Competibacter",
              "g__Defluviicoccus",
              "g__Propionivibrio",
              "g__Micropruina",
              "g__Ca_Contendobacter",
              "g__Ca_Proximibacter")
Filaments <- c("g__Ca_Microthrix", "g__Leptothrix","g__Sphaerotilus","g__Ca_Villigracilis","g__Trichococcus",
               "g__Thiothrix","g__Ca_Promineofilum","Haliscomenobacter","g__Gordonia","g__Sarcinithrix",
               "g__Ca_Amarolinea","g__Kouleothrix","g__Ca_Alysiosphaera",
               "g__Nocardioides","g__midas_g_1668","g__Anaerolinea","g__Ca_Caldilinea",
               "g__Ca_Hadersleviella","g__midas_g_344",
               "g__Skermania","g__Ca_Nostocoida","g__Neomegalonema","g__Beggiatoa",
               "g__Ca_Brevefilum") 



df_functional <- 
  tibble(Genus = c(Nitrifiers, Denitrifiers, PAOs, GAOs, Filaments), 
         functional_group =  c(rep("Nitrifiers", length(Nitrifiers)), 
                               rep("Denitrifiers", length(Denitrifiers)),
                               rep("PAOs", length(PAOs)),
                               rep("GAOs", length(GAOs)),
                               rep("Filaments", length(Filaments))
                               ))
```



# Save ampvis data to Rodrigo

```{r, include=FALSE}

saveRDS(data_0.6, file = paste0(OutputPath, "R_environment/Rodrigo/ampvis_0.6_sintax.RDS"))
#data_0.6 <- readRDS(paste0(OutputPath, "R_environment/Rodrigo/ampvis_0.6_sintax.RDS"))
saveRDS(data_0.8, file = paste0(OutputPath, "R_environment/Rodrigo/ampvis_0.8_sintax.RDS")) 
#data_0.8 <- readRDS(paste0(OutputPath, "R_environment/Rodrigo/ampvis_0.8_sintax.RDS"))



# data_0.8$tax %>% filter(str_detect(Genus, "Dechlo")) 
# data_long_0.6 %>% sample_n(1) %>% 
#   unnest(samples) %>% filter(str_detect(Genus, "Dechlo"))
# 
# data_0.8$metadata %>% distinct(SampleSite)
# 
# dataSewers0.8<-amp_subset_samples(Data0.8, SampleSite %in% c("Roden","Skolesti","Visse","Doctorvej","Tvaesgade",
#                                                              "Sejlflod","Frejlev",
#                                                              "Stadionvej","AalborgWest_before"))
# #test
# # Rename levels
# data_0.8$metadata$Configuration 
# 
# data_0.8$metadata$Configuration <- factor(
#   data_0.8$metadata$Configuration,
#   levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
#   labels = c("Gravity", "Pressure", "AAW")
# )
# 
# data_0.8$metadata$SampleID2
# data_long_0.8 %>% distinct(SampleID2)
# 
# # data_0.6 %>% 
# #    amp_subset_samples(normalise = T) %>% 
# #    amp_subset_taxa(tax_vector = 
# #                      unlist(df_functional %>% 
# #                               filter(functional_group == "PAOs") %>% 
# #                               select(Genus))
# #                    ) %>% 
# #    amp_heatmap(group_by = "SampleContent2", tax_aggregate = "Genus", normalise = F, round = 2)
# # 
# data_0.8 %>%
#    amp_subset_samples(normalise = T) %>%
#    amp_subset_samples(Configuration == "gravity_pipes") %>% 
#   amp_subset_samples(SampleContent2 == "Biofilm (g.)") %>% 
#    amp_subset_taxa(tax_vector =
#                      unlist(df_functional %>%
#                               filter(functional_group == "PAOs") %>%
#                               select(Genus))
#                    ) %>%
#    amp_heatmap(group_by = "SampleContent_SampleSite_SampleDate", 
#                tax_aggregate = "Genus", normalise = F, 
#                round = 1)
# 
# data_0.8 %>%
#    amp_subset_samples(normalise = T) %>%
#    amp_subset_samples(Configuration == "gravity_pipes") %>% 
#   amp_subset_samples(SampleContent2 == "Biofilm (g.)") %>% 
#    amp_subset_taxa(tax_vector =
#                      unlist(df_functional %>%
#                               filter(functional_group == "PAOs") %>%
#                               select(Genus))
#                    ) %>%
#    amp_heatmap(group_by = "SampleContent_SampleSite", 
#                tax_aggregate = "Genus", normalise = F, 
#                round = 1)


```



# Ordinations of sewer envionements (genus level)

## Biofilm only {.tabset}

### Sintax 0.6

```{r}

PCOA_0.6 <- data_long_0.6 %>% 
  filter(!SampleContent2 %in% c("IWW", "AS", "SWW", "Sediment")) %>% 
  #                                "biofilm_RG")) %>%  
  PCOA_from_long_df(tax_level = "Genus", abun_limit = 0.01, color_by = SampleContent2, extra_column = SampleSite) + 
  ggalt::geom_encircle(aes(fill = color, group = color), alpha = 0.20, expand=0) + 
  geom_text_repel(aes(label = if_else(color == "Biofilm (p.)", extra_column_name , " ")), color = "black", size =3) + 
  scale_color_manual(values = SampleContent2_colors) +
  scale_fill_manual(values = SampleContent2_colors) +
  theme_bw() + 
  guides(fill = guide_legend(title = "Sample type", nrow = 1),
         color = guide_legend(title = "Sample type", , nrow = 1)) +
  theme(#legend.title = element_blank(), 
        legend.position = "bottom")

PCOA_0.6
```

### Sintax 0.8

```{r}

PCOA_0.8 <- data_long_0.8 %>% 
  filter(!SampleContent2 %in% c("IWW", "AS", "SWW", "Sediment")) %>% 
  #                                "biofilm_RG")) %>%  
  PCOA_from_long_df(tax_level = "Genus", abun_limit = 0.01, color_by = SampleContent2, extra_column = SampleSite) + 
  ggalt::geom_encircle(aes(fill = color, group = color), alpha = 0.20, expand=0) + 
  geom_text_repel(aes(label = if_else(color == "Biofilm (p.)", extra_column_name , " ")), color = "black", size =3) + 
  scale_color_manual(values = SampleContent2_colors) +
  scale_fill_manual(values = SampleContent2_colors) +
  theme_bw() + 
  guides(fill = guide_legend(title = "Sample type", nrow = 1),
         color = guide_legend(title = "Sample type", , nrow = 1)) +
  theme(#legend.title = element_blank(), 
        legend.position = "bottom")

PCOA_0.8

```



# HM at the genus level: top 15 for each system

## Figure XX: Most abundant genera across sewer envionments merged sample sites  {.tabset}

### Sintax 0.6

```{r}

# Create the bins and corresponding colors
## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long_0.6 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.6 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  # 
  # mutate(lab = case_when(
  #       str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
  #       !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
  #       lab == "Remaining" ~ lab, .default = "missing"),
  #        lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
  #        lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
  #       
  # ) %>% 
  #  mutate(lab_genus = case_when(
  #       str_detect(Family, "midas") & str_detect(Family, "midas") ~ paste0(str_remove(Family, "f__")),
  #       !str_detect(Family, "midas") ~ paste0("*", str_remove(Family, "f__"), "*")),
  #       lab_genus = if_else(str_detect(lab_genus, "Ca_"), str_remove_all(lab_genus, "\\*"), lab_genus),
  #        lab_genus = str_replace_all(lab_genus, "Ca_", "*Ca.* "), 
  # ) %>% 
  distinct(Genus, Family, lab) 
# %>% 
#   mutate(lab = if_else(lab != "Remaining", paste0(lab_genus,";",lab), lab))


# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(top_each_samplecontent_groups$Genus))
                   )) %>% 
    unnest(samples) %>%
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c("Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (e.p.)",
                                                    "Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)"," ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  # geom_text(aes(label = case_when(
  #   mean >= 10 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 0)),
  #   mean >= 1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 1)),
  #   mean < 1 & mean > 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 2)),
  #   mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ "",
  #   mean >= 0.1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
  #   lab == "Remain. species" ~ paste0(round(mean_n_species, 0)),
  #   is.na(mean) ~ "", .default = "missing",
  #                                 ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_blank(), #element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))


plot_name = "SXX_heatmap_top20_abundant_genera_biofilm_ep_and_biofilm_p_merged_site_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

### Sintax 0.8

```{r}

## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long_0.8 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.8 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  distinct(Genus, Family, lab) 

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(top_each_samplecontent_groups$Genus))
                   )) %>% 
    unnest(samples) %>%
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c("Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (e.p.)",
                                                    "Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)"," ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_blank(), #element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))




plot_name = "SXX_heatmap_top20_abundant_genera_biofilm_ep_and_biofilm_p_merged_site_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```


## Figure XX: Most abundant genera across sewer envionments per sample site {.tabset}

### Sintax 0.6

```{r}

# Create the bins and corresponding colors
#bins <- c(0, 0.1, 1, 2, 5, 10, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long_0.6 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.6 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  distinct(Genus, Family, lab) 

# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(top_each_samplecontent_groups$Genus))
                   )) %>% 
    unnest(samples) %>%
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c("Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (e.p.)",
                                                    "Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)"," ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 10, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        #axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x =element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))




plot_name = "SXX_heatmap_top20_abundant_genera_per_sample_site_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 18, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```

### Sintax 0.8

```{r}

# Create the bins and corresponding colors
#bins <- c(0, 0.1, 1, 2, 5, 10, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

#Select top 20
top_each_samplecontent <- data_long_0.8 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.8 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  distinct(Genus, Family, lab) 

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(top_each_samplecontent_groups$Genus))
                   )) %>% 
    unnest(samples) %>%
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c("Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (p.)", 
                                                    "Biofilm (g.);Biofilm (e.p.)",
                                                    "Biofilm (e.p.);Biofilm (p.)", 
                                                    "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)"," ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 10, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        #axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x =element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))




plot_name = "SXX_heatmap_top20_abundant_genera_per_sample_site_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 18, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```


# HM at the genus level: top 15 for each system --> also SWW

## Figure XX: Most abundant genera across sewer envionments merged sample sites  {.tabset}

### Sintax 0.6

```{r}

# Create the bins and corresponding colors
## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long_0.6 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)", "SWW"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 15) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.6 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  # 
  # mutate(lab = case_when(
  #       str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
  #       !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
  #       lab == "Remaining" ~ lab, .default = "missing"),
  #        lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
  #        lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
  #       
  # ) %>% 
  #  mutate(lab_genus = case_when(
  #       str_detect(Family, "midas") & str_detect(Family, "midas") ~ paste0(str_remove(Family, "f__")),
  #       !str_detect(Family, "midas") ~ paste0("*", str_remove(Family, "f__"), "*")),
  #       lab_genus = if_else(str_detect(lab_genus, "Ca_"), str_remove_all(lab_genus, "\\*"), lab_genus),
  #        lab_genus = str_replace_all(lab_genus, "Ca_", "*Ca.* "), 
  # ) %>% 
  distinct(Genus, Family, lab) 
# %>% 
#   mutate(lab = if_else(lab != "Remaining", paste0(lab_genus,";",lab), lab))


# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(!(rel_abun_genus == 0 & 
                              !Genus %in% unlist(top_each_samplecontent_groups$Genus)))
                   )) %>% 
    unnest(samples) %>%
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c(
                                           "Biofilm (g.);Biofilm (e.p.);Biofilm (p.);SWW",
                                           "Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                           "Biofilm (g.);Biofilm (p.)", 
                                           "Biofilm (g.);Biofilm (e.p.)",
                                           "Biofilm (e.p.);Biofilm (p.)", 
                                           "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)", "SWW",
                                                    " ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  # geom_text(aes(label = case_when(
  #   mean >= 10 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 0)),
  #   mean >= 1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 1)),
  #   mean < 1 & mean > 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 2)),
  #   mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ "",
  #   mean >= 0.1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
  #   lab == "Remain. species" ~ paste0(round(mean_n_species, 0)),
  #   is.na(mean) ~ "", .default = "missing",
  #                                 ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_blank(), #element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))


plot_name = "SXX_heatmap_top15_abundant_genera_SWW_biofilm_ep_and_biofilm_p_merged_site_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

### Sintax 0.8

```{r}

## Other bins (remember to change labels manually)
bins <- c(0,0.0000000000000000001, 0.01, 0.1, 1, 5,10, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long_0.8 %>%
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)", "Biofilm (p.)", "Biofilm (e.p.)", "SWW"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 15) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) #%>% print(n=100)

# Number of unique genera 
#unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long_0.8 %>% sample_n(1) %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
   mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  distinct(Genus, Family, lab) 

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% #sample_n(20) %>% 
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(top_each_samplecontent_groups$Genus))
                   )) %>% 
    unnest(samples) %>%
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 


new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(SampleEnvironment_obs, mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. genera"=" "),
    mean = ifelse(lab == "Remain. genera", 0, mean),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE), 
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    )  
# %>% 
#   filter(lab != "Remain. abundance")


#unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(
         #SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         #SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                         levels = c(
                                           "Biofilm (g.);Biofilm (e.p.);Biofilm (p.);SWW",
                                           "Biofilm (g.);Biofilm (e.p.);Biofilm (p.)", 
                                           "Biofilm (g.);Biofilm (p.)", 
                                           "Biofilm (g.);Biofilm (e.p.)",
                                           "Biofilm (e.p.);Biofilm (p.)", 
                                           "Biofilm (g.)", "Biofilm (e.p.)", "Biofilm (p.)", "SWW",
                                                    " ")),
         x = "x") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(SampleEnvironment_obs~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.1", "0.1-1", "1-5", "5-10", ">10")) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16, angle = 0), #element_blank(),
        panel.grid = element_blank(),
        axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_blank(), #element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))




plot_name = "SXX_heatmap_top15_abundant_genera_SWW_biofilm_ep_and_biofilm_p_merged_site_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```




# PAOs and GAOs in the sewer

## Figure SXX: Heatmap of PAO and GAOs merged samplesites {.tabset}

### Sintax 0.6

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_blank(), #element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 
plot_name = "Figure_XX_heatmap_functinal_guilds_sintax_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 12, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```


### Sintax 0.8

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 2)),
                                  mean < 0.01 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_blank(), #element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 

plot_name = "Figure_XX_heatmap_functinal_guilds_sintax_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 12, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))


```


## Figure SXX: Heatmap of PAO and GAOs for each samplesite {.tabset}

### Sintax 0.6

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 



plot_name = "Figure_XX_heatmap_functinal_guilds_per_sample_site_sintax_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 12, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```


### Sintax 0.8

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 


plot_name = "Figure_XX_heatmap_functinal_guilds_per_sample_site_sintax_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 12, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```


```{r, eval=FALSE}

# Create the bins and corresponding colors
bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long %>% #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0)
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* ")
  ) %>% 
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         Configuration = factor(Configuration, 
                                levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
                                labels = c("Gravity sewers", "Pressure sewers", "WWTP")),
         SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         SampleSite = recode(SampleSite, AalborgWest = "Aalborg West")
         )


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
  filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(
    mean >= 10 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 0)),
    mean >= 1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 1)),
    mean < 1 & mean > 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 2)),
    mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ "",
    mean >= 0.1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
    lab == "Remain. species" ~ paste0(round(mean_n_genus, 0)),
    is.na(mean) ~ "", .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        plot.background = element_rect(fill = "white"),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 

plot

plot_name = "Figure_XX_heatmap_functinal_guilds_for_aech_sample_site"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 12, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```


## Each site by date

### Figure XX: Biofilm (g) {.tabset}

#### Sintax 0.6

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% 
  filter(SampleContent2 == "Biofilm (g.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 


plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_g_per_sample_date_sintax_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

#### Sintax 0.8

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% 
  filter(SampleContent2 == "Biofilm (g.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 

plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_g_per_sample_date_sintax_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

### Figure XX: Biofilm (p.) {.tabset}

#### Sintax 0.6

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% 
  filter(SampleContent2 == "Biofilm (p.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 

plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_p_per_sample_date_sintax_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

#### Sintax 0.8

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% 
  filter(SampleContent2 == "Biofilm (p.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 



plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_p_per_sample_date_sintax_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```


### Figure XX: Biofilm (e.p.) {.tabset}

#### Sintax 0.6

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


# Make a dataframe for plotting 
plot_df <- data_long_0.6 %>% 
  filter(SampleContent2 == "Biofilm (e.p.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 



plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_ep_per_sample_date_sintax_0.6"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```

#### Sintax 0.8

```{r}

# Create the bins and corresponding colors
bins <- c(0, 0.0000000000000000001, 0.01, 0.05,0.1, 1, 5, Inf)
colors <- c("grey90","white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

# Make a dataframe for plotting 
plot_df <- data_long_0.8 %>% 
  filter(SampleContent2 == "Biofilm (e.p.)") %>%   #sample_n(20) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus, Family) %>% 
                   inner_join(df_functional, by = "Genus") %>% 
                   filter(rel_abun_genus != 0 | Genus %in% unlist(df_functional$Genus))
                   )) %>% 
    unnest(samples) %>% 
  filter(functional_group %in% c("PAOs", "GAOs")) %>% #Filter only to include PAOs and GAOs
   mutate(
     lab = Genus,
     lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        lab = if_else(str_detect(lab, "midas"), paste0("*", str_sub(Family,4), "*; ", lab), lab),
  ) %>% 
  mutate(SampleSite = paste0(SampleSite, ";", SampleDate)) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, lab, SampleID, functional_group, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_genus = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, lab, Genus, functional_group, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_genus = mean(n_genus),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
         functional_group = factor(functional_group, 
                                   levels = c("PAOs", "GAOs")),
         # Configuration = factor(Configuration, 
         #                        levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
         #                        labels = c("Gravity sewers", "Pressure sewers", "Aalborg West WWTP")),
         #SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)"),
         ) %>% 
  arrange(functional_group, mean_across_all) %>% 
  mutate(lab = fct_inorder(lab))


# Make the heatmap 
plot <- 
  # HEATMAP
  plot_df %>% 
    filter(SampleContent2 != "Sediment") %>% 
  ggplot(aes(x = SampleSite, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(functional_group~Configuration+SampleContent2, scales = "free", space = "free") +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6,7), 
                    labels = c("0","0-0.01", "0.01-0.05", "0.05-0.1", "0.1-1", "1-5", ">5")
                    ) +
  scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ 
                                    paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. genera" ~ "",
                                  mean >= 1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. genera" ~ paste0(round(mean_n_genus, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12),
        legend.title = element_text(vjust = 1, size = 16),
        panel.grid = element_blank(),
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        strip.text.y = element_text(angle = 0, size = 16),
        strip.background = element_rect(fill = "grey90"),
        axis.text.x = element_text(size = 12, hjust = 1, vjust = 1, angle = 45),
        #panel.background = element_rect(fill = "white"),
        legend.position = "bottom", 
        #axis.ticks.x = element_blank()
        ) +
  guides(fill = guide_legend(reverse = TRUE, nrow = 1,
                             override.aes = list(color = "black", size = 0.5))) 



plot_name = "Figure_XX_heatmap_functinal_guilds_biofilm_ep_per_sample_date_sintax_0.8"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 9, height = 5)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))



```



## Most abundant genera by date

NOT MADE YES  

### Figure XX: Biofilm (g) {.tabset}

### Figure XX: Biofilm (p.) {.tabset}

### Figure XX: Biofilm (e.p.) {.tabset}





```{r, eval=FALSE}

# Create the bins and corresponding colors
bins <- c(0, 0.1, 1, 2, 5, 10, Inf)
colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long %>%
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (g.)"#, "Biofilm (p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) %>% print(n=100)

# Number of unique genera 
unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long %>% sample_n(1) %>% 
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
  mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        
  ) %>% 
   mutate(lab_genus = case_when(
        str_detect(Family, "midas") ~ paste0(str_remove(Family, "f__")),
        !str_detect(Family, "midas") ~ paste0("*", str_remove(Family, "f__"), "*")),
        lab_genus = if_else(str_detect(lab_genus, "Ca_"), str_remove_all(lab_genus, "\\*"), lab_genus),
         lab_genus = str_replace_all(lab_genus, "Ca_", "*Ca.* "), 
  ) %>% 
  distinct(Genus, Family, lab, lab_genus) %>% 
  mutate(lab = if_else(lab != "Remaining", paste0(lab_genus,";",lab), lab))


# Make a dataframe for plotting 
plot_df <- data_long %>% #sample_n(20) %>% 
  filter(SampleContent2 %in%
             c("Biofilm (g.)")) %>%
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0)
                   )) %>% 
    unnest(samples) %>%
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, SampleDate,lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, SampleDate, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 



new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. species"=" "),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    ) 
# %>% 
#   
#   filter(lab != "Remain. abundance")


unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(Configuration = factor(Configuration, 
                                levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
                                labels = c("Gravity mains", "Pressure mains", "WWTP")),
         SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                        levels = c("Biofilm (g.);Biofilm (p.)", "Biofilm (g.)", "Biofilm (p.)", " ")),
         x = "x", 
         SampleDate_num = as.numeric(SampleDate), 
         SampleDate = as.character(SampleDate)) %>% 
  ggplot(aes(x = SampleDate, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(x~SampleContent2+SampleSite, scales = "free", space = "free"#, independent = "x"
                      ) +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6), 
                    labels = c("0-0.1", "0.1-1", "1-2", "2-5", "5-10", ">10")) +
  #scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(
    mean >= 10 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 0)),
    mean >= 1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 1)),
    mean < 1 & mean > 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 2)),
    mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ "",
    mean >= 0.1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
    lab == "Remain. species" ~ paste0(round(mean_n_species, 0)),
    is.na(mean) ~ "", .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16), #element_blank(),
        panel.grid = element_blank(),
        #axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))




plot_name = "SXX_heatmap_top20_abundant_genera_biofilm_g_per_site_per_date"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16.5, height = 10)
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))






```

```{r, eval=FALSE}

# Create the bins and corresponding colors
bins <- c(0, 0.1, 1, 2, 5, 10, Inf)
colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")

## Other bins (remember to change labels manually)
#bins <- c(0, 0.01, 0.05,0.1, 1, 5, Inf)
#colors <- c("white","#FFF5EB", "#F5C9B0", "#EC9E75", "#E2733B", "#D94801")


#Select top 20
top_each_samplecontent <- data_long %>%
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
    filter(SampleContent2 %in% 
             c("Biofilm (p.)"#, "Biofilm (p.)"#, "Sediment"
               )) %>% 
  #filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
  mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   filter(!str_detect(Genus, "unclas")))
    ) %>% 
    unnest(samples) %>% 
  group_by(SampleContent2, Genus, SampleEnvironment) %>% 
  summarise(mean = mean(rel_abun_genus), .groups = "drop") %>% 
  group_by(SampleContent2, SampleEnvironment) %>% 
  slice_max(order_by = mean, n = 20) %>% ungroup() %>% 
  select(-mean)

# 
top_each_samplecontent_groups <- top_each_samplecontent %>%
  group_by(Genus) %>% 
  summarise(SampleEnvironment_obs = paste0(unique(SampleContent2), collapse = ";")) %>% print(n=100)

# Number of unique genera 
unique(top_each_samplecontent$Genus)

# Merge reamining
merge_vec <- 
  data_long %>% sample_n(1) %>% 
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
  unnest(samples) %>% 
  mutate(lab = case_when(Genus %in% unlist(top_each_samplecontent$Genus) ~ Genus, 
                         !Genus %in% unlist(top_each_samplecontent$Genus) ~ "Remaining", 
                         .default = "missing")) %>%
  mutate(lab = case_when(
        str_detect(Genus, "midas") & lab != "Remaining" ~ paste0(str_remove(Genus, "g__")),
        !str_detect(Genus, "midas") & lab != "Remaining"~ paste0("*", str_remove(Genus, "g__"), "*"),
        lab == "Remaining" ~ lab, .default = "missing"),
         lab = if_else(str_detect(lab, "Ca_"), str_remove_all(lab, "\\*"), lab),
         lab = str_replace_all(lab, "Ca_", "*Ca.* "), 
        
  ) %>% 
   mutate(lab_genus = case_when(
        str_detect(Family, "midas") ~ paste0(str_remove(Family, "f__")),
        !str_detect(Family, "midas") ~ paste0("*", str_remove(Family, "f__"), "*")),
        lab_genus = if_else(str_detect(lab_genus, "Ca_"), str_remove_all(lab_genus, "\\*"), lab_genus),
         lab_genus = str_replace_all(lab_genus, "Ca_", "*Ca.* "), 
  ) %>% 
  distinct(Genus, Family, lab, lab_genus) %>% 
  mutate(lab = if_else(lab != "Remaining", paste0(lab_genus,";",lab), lab))


# Make a dataframe for plotting 
plot_df <- data_long %>% #sample_n(20) %>% 
  filter(SampleContent2 %in%
             c("Biofilm (e.p.)")) %>%
  filter(SampleContent2 != "Sediment") %>% 
  mutate(
    SampleContent2 = fct_recode(SampleContent2, "Biofilm (p.)" = "Biofilm (e.p.)")
    ) %>% 
   filter(!SampleSite %in% c("AalborgØst", "AalborgØst_after", "AalborgWest_after")) %>% 
   mutate(samples = 
             map(.x = samples, ~
                   ungroup(.) %>% 
                   distinct(Genus, rel_abun_genus) %>% 
                   inner_join(merge_vec, by = "Genus") %>% 
                   filter(rel_abun_genus != 0)
                   )) %>% 
    unnest(samples) %>%
  #mutate(SampleSite = SampleContent2) %>%  #### MERGE SAMPLESITES
  group_by(SampleContent2, SampleSite, SampleDate,lab, SampleID, Configuration) %>% 
  reframe(
    sum = sum(rel_abun_genus), 
    n_species = n(),
    Genus = if_else(lab == "Remaining", "", Genus)
    ) %>% 
  group_by(SampleContent2, SampleSite, SampleDate, lab, Genus, Configuration) %>% 
  summarise(
      mean = mean(sum), 
      mean_n_species = mean(n_species),
      .groups = "drop") %>% 
  group_by(lab) %>% 
  mutate(mean_across_all = mean(mean, na.rm = T)) %>% 
  ungroup() %>% 
  full_join(top_each_samplecontent) %>% 
  ungroup()

## Factor final dataframe
new_rows <- plot_df %>%
  filter(lab == "Remaining") %>%
  mutate(lab = " ", 
         SampleEnvironment = "Remain.") 



new_plot_df <- plot_df %>% rbind(new_rows, plot_df) %>% #print(n = 100) %>%
  full_join(top_each_samplecontent_groups, by = join_by(Genus)) %>%
  arrange(mean_across_all) %>% 
  mutate(
    lab = if_else(str_detect(lab,"Allorhizobium-Neo"), str_replace(lab, "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Allorhizobium-Neo."),lab),
    lab = fct_inorder(lab),
    lab = fct_relevel(lab, "Remaining", after = 0),
    lab = fct_relevel(lab, " ", after = 0),
    lab = fct_recode(lab,"Remain. abundance"="Remaining"),
    lab = fct_recode(lab, "Remain. species"=" "),
    bin = cut(mean, breaks = bins, labels = FALSE, right = FALSE),
    SampleEnvironment_obs = if_else(str_detect(lab, "Remain."), " ", SampleEnvironment_obs)
    ) 
# %>% 
#   
#   filter(lab != "Remain. abundance")


unique(new_plot_df$SampleEnvironment_obs)   

# Make the heatmap 
plot <- 
  # HEATMAP
  new_plot_df %>% 
  mutate(Configuration = factor(Configuration, 
                                levels = c("gravity_pipes", "end_of_pressure", "WWTP"),
                                labels = c("Gravity mains", "Pressure mains", "WWTP")),
         SampleSite = recode(SampleSite, AalborgWest_before = "Aalborg West"),
         SampleSite = recode(SampleSite, AalborgWest = "Aalborg West"),
         SampleEnvironment_obs = factor(SampleEnvironment_obs, 
                                        levels = c("Biofilm (g.);Biofilm (p.)", "Biofilm (g.)", "Biofilm (p.)", " ")),
         x = "x", 
         SampleDate_num = as.numeric(SampleDate), 
         SampleDate = as.character(SampleDate)) %>% 
  ggplot(aes(x = SampleDate, y = lab, fill = as.factor(bin))) + 
  geom_tile() + 
  ggh4x::facet_nested(x~SampleContent2+SampleSite, scales = "free", space = "free"#, independent = "x"
                      ) +
  labs(fill="Relative abundance [%]") +
  scale_fill_manual(values = colors, 
                    breaks = c(1,2,3,4,5,6), 
                    labels = c("0-0.1", "0.1-1", "1-2", "2-5", "5-10", ">10")) +
  #scale_x_discrete(expand = c(0,0)) + 
  geom_text(aes(label = case_when(mean >= 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ paste0(round(mean, 1)),
                                  mean < 0.1 & lab != "Remain. abundance" &  lab != "Remain. species" ~ "",
                                  mean >= 0.1 & lab == "Remain. abundance" ~ paste0(round(mean, 1)),
                                  lab == "Remain. species" ~ paste0(round(mean_n_species, 0)),
                                  is.na(mean) ~ "",
                                  .default = "missing",
                                  ))) +  #)
  theme(axis.text.y = element_markdown(size = 12, color = "black"),
        legend.title = element_text(vjust = 1, size = 16),
        strip.text.y = element_text(size = 16), #element_blank(),
        panel.grid = element_blank(),
        #axis.ticks.x = element_blank(), 
        legend.position = "bottom",
        strip.text.x = element_text(size = 16),
        axis.title = element_blank(), 
        legend.text = element_text(size = 14), 
        strip.background = element_rect(fill = "grey90"),
        #strip.text.y = element_blank(), #element_text(angle = 0, size = 16),
        axis.text.x = element_text(size = 14, hjust = 1, vjust = 1, angle = 45, color = "black"),
        #plot.background = element_rect(fill = "grey70")
        ) +
  guides(fill = guide_legend(reverse = TRUE,
                             override.aes = list(color = "black", 
                                                 size = 0.8), nrow = 1))


plot

plot_name = "SXX_heatmap_top20_abundant_genera_biofilm_ep_per_site_per_date"
ggsave(plot = plot, paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"), width = 16.5, height = 10, dpi = 600
       )
knitr::include_graphics(paste0(OutputPath, "plots/plots_to_Rodrigo/", plot_name, ".png"))






```





















